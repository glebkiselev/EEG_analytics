## Описание

TensorFlow Lite-модель для классификации данных ЭЭГ,
предназначена для запуска на микроконтроллере.

В репозитории содержится модель в форматах keras и tflite, программа для контроллера
на базе Arduino и тесты-примеры в Jupyter Notebook.

Программа для Arduino содержит веб-сервер с запущенной на нем моделью
для удобства тестирования модели в реальном времени.

## Установка программы

Программа для контроллера написана на C++ под среду выполнения Arduino.
Сборка проекта выполняется с помощью CMake и [набора инструментов для Arduino](https://github.com/technyon/Arduino-CMake-Toolchain).

Процесс установки в рамках настоящего репозитория был произведен именно этим способом,
однако существует также более легкий способ, который описан ниже.

Для обоих способов необходима одна и та же первоначальная настройка.

Программа была протестирована на плате `MH ET Live ESP32 DevKit`.
Ниже представлен отчет об используемой памяти.

```
################## Size Summary ##################
Program Size: 1208570 of 1310720 bytes (92%)
Data Size: 74048 of 327680 bytes (22%)
##################################################
```

*Замечание*: 72% программной памяти контроллера было занято логикой веб-сервера,
библиотеками WiFi, WebServer и Arduino Core.
20% заняты частью ML и библиотекой Chirale_TensorFLowLite.

### Начальная настройка

1. Загрузить Arduino IDE с [официального сайта](https://www.arduino.cc/en/software).
   *Замечание: В этом проекте использовалась Legacy-версия IDE, 
    однако технически она мало отличается от версии 2.x*
2. Убедиться, что в IDE имеется целевая плата микроконтроллера
   (Инструменты -> плата в Legacy IDE). Если нет - необходимо установить пакет плат,
   содержащий нужную через **менеджер плат**. Если в менеждере плат нет нужного пакета,
   его можно найти в качестве свободного ПО. Например, [STM32](https://github.com/stm32duino/Arduino_Core_STM32).
   Инструкцию по установке искать там же. 
3. В **менеджере библиотек** найти и установить `Chirale_TensorFLowLite`.

**Важно**: При использовании метода CMake с платформой **ESP32**, необходимо установить версию
`1.0.6` пакета `esp32` от `espressif`. Более поздние версии конфликтуют с существующим
CMake toolchain для Arduino и не компилируются. Совместимость как поздних, так и ранних версий с
методом Arduino IDE - не проверена.

### Cmake (проверенный вариант)

*Замечание:* Здесь не будут описаны методы работы с CMake. Если что-то не понятно -
ищите документацию.

Сборка проекта осуществляется в директории `arduino-ml`.

Проверенный набор инструментов (далее - toolchain) - MinGW `v. 11.0 w64.`,
генератор - `MinGW Makefiles`.

Перед сборкой необходимо загрузить репозиторий [Arduino-CMake-Toolchain](https://github.com/technyon/Arduino-CMake-Toolchain)
в отдельную директорию:

```
git clone --recursive https://github.com/technyon/Arduino-CMake-Toolchain
```

После чего скопировать путь до файла `Arduino-toolchain.cmake`. Этот файл необходимо указать
как toolchain для CMake.

На этом этапе можно выполнять первоначальную сборку CMake. Обратите внимание, что в этом
проекте есть обязательные параметры при сборке, о чем написано ниже.

После первой сборки, в build-директории (ее название указывается пользователем в большинстве случаев)
будет находиться файл настроек платы `BoardOptions.cmake`, где нужно выбрать модель платы и ее настройки.
Уже настроенный подобный файл для упомянутой выше платы называется `MHET-ESP32-DevKit.cmake`.
Его можно использовать в параметрах сборки, либо просто скопировать, заменив им `BoardOptions.cmake`

Пример параметров сборки CMake:

```
-G "MinGW Makefiles" -DCMAKE_TOOLCHAIN_FILE="path/to/Arduino-CMake-Toolchain/Arduino-toolchain.cmake" -DARDUINO_BOARD_OPTIONS_FILE=$CMakeProjectDir$/MHET-ESP32-DevKit.cmake -DSERIAL_PORT=COM4 -DWIFI_SSID=somessid -DWIFI_PASSWD=somepassword123
```

Здесь:
 - `-DCMAKE_TOOLCHAIN_FILE` - путь до указанного выше файла toolchain-а.
 - `-DARDUINO_BOARD_OPTIONS_FILE` - Путь до файла с выбранными настройками платы. *Опционально*.
 - `-DSERIAL_PORT` - порт, на котором находится плата. Для проверки, она должна также отображаться в Arduino IDE.
    Прослушивание порта в IDE при этом **должно быть выключено**.
 - `-DWIFI_SSID` и `-DWIFI_PASSWD` - название сети WIFI и пароль. Будет записано в файл `src/wifi_conf.hpp` после сборки.
    **Обязательно.**

#### Возможные проблемы

##### ... no such file: partitions.csv
По какой-то причине этот файл не всегда копируется на основе настроек платы.
Его можно найти по пути `%LocalAppData%\Arduino15\packages\esp32\hardware\esp32\1.0.6\tools\partitions`
для ESP32. В этой директории есть несколько разных вариантов разметки памяти.
В большинстве случаев, нужен вариант `default.csv`. Скопируйте его в build-директорию, переименовав в
`partitions.csv`.

##### Сборка CMake или самого проекта заканчивается с ошибкой
Если вы используете ESP32, проверьте версию пакета `esp32` в менеджере плат.
Рабочая с этим toolchain версия - `1.0.6`.

### Arduino IDE (альтернативный вариант)

Для загрузки программы через Arduino IDE, можно просто подключить в ней все файлы из
директории `src/`. Однако, этот метод не был проверен в рамках этого проекта.

Скорее всего, нужно будет как минимум убрать все директивы `#include "Arduino.h"` из исходного кода.

Также нужно переименовать `wifi_conf.hpp.in` в `wifi_conf.hpp` и задать в нем явно имя WiFi сети и пароль.
